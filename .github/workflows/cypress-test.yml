name: Cypress Tests

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm install

      # Step 4: Run Cypress tests
      - name: Run Cypress tests
        uses: cypress-io/github-action@v5
        with:
          spec: cypress/e2e/login.cy.js

      # Step 5: Upload Cypress screenshots if tests fail
      - name: Upload failed screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-screenshots
          path: cypress/screenshots/

      # Step 6: Notify n8n workflow if tests fail
      - name: Notify n8n on failure
        if: failure()
        run: |
          curl -X POST "https://moiz496.app.n8n.cloud/webhook/003ddbb5-aa03-41c0-8b72-1d1d0f0f717a" \
          -H "Content-Type: application/json" \
          -d '{
            "repository": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}",
            "runId": "${{ github.run_id }}",
            "artifact": "failed-screenshots"
          }'

  # Second job â€” always runs and downloads artifacts
  download-artifacts:
    runs-on: ubuntu-latest
    needs: cypress-run
    if: always() # ensures this runs even if tests fail

    steps:
      - name: Download failed screenshots
        uses: actions/download-artifact@v4
        with:
          name: failed-screenshots
          path: ./screenshots